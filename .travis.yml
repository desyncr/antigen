sudo: required
dist: trusty
language: generic
services:
  - docker
cache:
  pip: true
matrix:
  include:
    - os: osx
      language: generic
      env: USE_CONTAINER=no
    - os: linux
      env: ZSH_VERSION=zsh-5.3.1
    - os: linux
      env: ZSH_VERSION=zsh-5.3
    - os: linux
      env: ZSH_VERSION=zsh-5.2
    - os: linux
      env: ZSH_VERSION=zsh-5.1.1
    - os: linux
      env: ZSH_VERSION=zsh-5.0.0
    - os: linux
      env: ZSH_VERSION=zsh-4.3.17
    - os: linux
      env: ZSH_VERSION=zsh-4.3.11

before_install:
  - if [ $TRAVIS_OS_NAME == 'osx' ]; then brew install zsh; pip install cram; fi
  - if [ $TRAVIS_OS_NAME == 'osx' ]; then PROJECT=$TRAVIS_BUILD_DIR; else PROJECT=/antigen; fi

script:
  - make info tests stats PROJECT=$PROJECT USE_CONTAINER=$USE_CONTAINER

  # Ensure the checked-in build matches the build produced in CI. Since the CI
  # will run this on both OS X and Linux, the two platforms must also produce
  # the same build, else one of them will fail.
  - SHASUM=$(shasum -a 256 ./bin/antigen.zsh)
  - make PROJECT=$PROJECT USER_CONTAINER=$USE_CONTAINER
  - SHACHECK=$(shasum -a 256 ./bin/antigen.zsh)

  - echo -e "$SHASUM\n$SHACHECK"
  - test "$SHASUM" == "$SHACHECK"
